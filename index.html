<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResuMatch Pro | Enterprise Resume Intelligence</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { 500: '#6366f1', 600: '#4f46e5', 900: '#1e1b4b' } },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { 
            background: #0f172a url('backgroundImg.jpg') center center/cover no-repeat fixed; 
            color: #f8fafc; 
        }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-light { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-heavy { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.03); }
        .sidebar-link.active { background: rgba(99, 102, 241, 0.15); backdrop-filter: blur(8px); border-left: 3px solid #6366f1; color: white; }
        .sidebar-link { border-left: 3px solid transparent; }
        .sidebar-link:hover { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(6px); }
        /* Printable Report Styles */
        @media print { .no-print { display: none; } body { background: white; color: black; } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-64 glass-heavy border-r border-white/5 flex flex-col no-print z-20">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-brand-500 rounded-lg flex items-center justify-center text-white font-bold"><i class="fa-solid fa-cube"></i></div>
            <span class="font-bold text-lg tracking-tight">ResuMatch <span class="text-brand-500">Pro</span></span>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-4">
            <p class="text-xs font-bold text-slate-500 uppercase px-4 mb-2">Modes</p>
            <button onclick="switchMode('candidate')" id="nav-candidate" class="sidebar-link active w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-white/5 rounded-r-lg transition flex items-center gap-3">
                <i class="fa-solid fa-user-astronaut w-5"></i> Candidate Optimizer
            </button>
            <button onclick="switchMode('recruiter')" id="nav-recruiter" class="sidebar-link w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-white/5 rounded-r-lg transition flex items-center gap-3">
                <i class="fa-solid fa-users-viewfinder w-5"></i> Recruiter Ranking
            </button>
            <button onclick="switchMode('settings')" id="nav-settings" class="sidebar-link w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-white/5 rounded-r-lg transition flex items-center gap-3">
                <i class="fa-solid fa-sliders w-5"></i> Model Settings
            </button>
        </nav>

        <div class="p-4 border-t border-white/5">
            <div class="glass-panel p-3 rounded-lg">
                <p class="text-xs text-slate-400 mb-1">Database Status</p>
                <div class="flex items-center gap-2 text-xs font-mono text-emerald-400">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    Local (Secure)
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-8 glass-heavy backdrop-blur-md z-10">
            <h2 id="pageTitle" class="text-lg font-semibold text-white">Candidate Optimizer</h2>
            <div class="flex gap-3">
                <button onclick="downloadReport()" class="hidden md:flex items-center gap-2 px-4 py-2 glass-light hover:glass-panel rounded-lg text-xs font-bold transition border border-white/10">
                    <i class="fa-solid fa-file-pdf"></i> Export Report
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8" id="contentArea">

            <div class="max-w-6xl mx-auto mb-8">
                <div class="glass-panel rounded-xl p-1">
                    <div class="glass-light rounded-xl p-5">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-brand-500 uppercase tracking-wider">Target Role (Baseline)</label>
                            <span class="text-xs text-slate-500">Paste JD to calibrate the AI</span>
                        </div>
                        <textarea id="jdInput" class="w-full h-32 bg-transparent text-sm text-slate-300 focus:outline-none resize-none placeholder-slate-600" placeholder="Paste Job Description here... We extract Hard Skills, Soft Skills, and Requirements."></textarea>
                    </div>
                </div>
            </div>

            <div id="view-candidate" class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
                <div class="lg:col-span-1 space-y-4">
                    <div class="glass-panel rounded-xl p-6 border-dashed border-2 border-slate-700 hover:border-brand-500 transition cursor-pointer relative group" onclick="document.getElementById('singleUpload').click()">
                        <input type="file" id="singleUpload" class="hidden" accept=".pdf" onchange="handleSingleUpload(this)">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-brand-500 transition">
                                <i class="fa-solid fa-cloud-arrow-up text-xl text-slate-400 group-hover:text-white"></i>
                            </div>
                            <p class="font-bold text-sm">Upload Resume (PDF)</p>
                            <p class="text-xs text-slate-500 mt-1">Deep Deep Analysis</p>
                        </div>
                    </div>
                    
                    <div class="glass-panel rounded-xl p-5 space-y-4 hidden" id="candidateStats">
                        <div>
                            <p class="text-xs text-slate-400">ATS Score</p>
                            <div class="flex items-end gap-2">
                                <span class="text-4xl font-bold text-white" id="singleScore">0%</span>
                                <span class="text-xs text-emerald-400 mb-1" id="singleVerdict">Waiting</span>
                            </div>
                            <div class="w-full bg-slate-700 h-1.5 rounded-full mt-2 overflow-hidden">
                                <div id="scoreBar" class="bg-brand-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="glass-light p-2 rounded">
                                <span class="block text-slate-500">Hard Skills</span>
                                <span class="font-bold text-white" id="cntHard">0</span>
                            </div>
                            <div class="glass-light p-2 rounded">
                                <span class="block text-slate-500">Soft Skills</span>
                                <span class="font-bold text-white" id="cntSoft">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6 hidden" id="candidateReport">
                    <div class="glass-panel rounded-xl p-6 border-l-4 border-red-500">
                        <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-red-500"></i> Critical Gaps</h3>
                        <div id="missingList" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div class="glass-panel rounded-xl p-6 border-l-4 border-amber-500">
                        <div class="flex justify-between mb-3">
                            <h3 class="font-bold text-white">Impact Analysis</h3>
                            <span class="text-xs glass-light px-2 py-1 rounded text-amber-400" id="verbScore">Weak Impact</span>
                        </div>
                        <p class="text-xs text-slate-400 mb-2">Recruiters look for "Power Verbs" (e.g., Led, Engineered, Optimized).</p>
                        <div id="verbList" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div class="glass-panel rounded-xl p-6 border-l-4 border-emerald-500">
                        <h3 class="font-bold text-white mb-3">Matched Capabilities</h3>
                        <div id="matchedList" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <div id="view-recruiter" class="hidden max-w-6xl mx-auto space-y-6">
                <div class="glass-panel rounded-xl p-8 text-center border-dashed border-2 border-slate-700 hover:border-brand-500 cursor-pointer" onclick="document.getElementById('batchUpload').click()">
                    <input type="file" id="batchUpload" class="hidden" accept=".pdf" multiple onchange="handleBatchUpload(this)">
                    <i class="fa-solid fa-users-viewfinder text-4xl text-slate-500 mb-4"></i>
                    <h3 class="text-xl font-bold">Bulk Candidate Screening</h3>
                    <p class="text-slate-400 text-sm mt-2">Upload 10, 20, or 50 resumes at once. We rank them instantly.</p>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden hidden" id="batchResults">
                    <div class="p-4 glass-light border-b border-white/5 flex justify-between items-center">
                        <h3 class="font-bold">Leaderboard</h3>
                        <span class="text-xs bg-brand-500 px-2 py-1 rounded text-white" id="candidateCount">0 Candidates</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase glass-light">
                                <tr>
                                    <th class="px-6 py-3">Rank</th>
                                    <th class="px-6 py-3">Candidate (File)</th>
                                    <th class="px-6 py-3">Match Score</th>
                                    <th class="px-6 py-3">Hard Skills</th>
                                    <th class="px-6 py-3">Soft Skills</th>
                                    <th class="px-6 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody" class="divide-y divide-white/5">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="hidden max-w-2xl mx-auto">
                <div class="glass-panel rounded-xl p-6">
                    <h3 class="font-bold mb-4">Dictionary Management</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500">Ignored Terms (AI Training)</label>
                            <div class="flex gap-2 mt-2">
                                <button onclick="resetMemory()" class="px-4 py-2 glass-light text-red-400 border border-red-500/20 rounded-lg text-xs hover:bg-red-500/20">Clear All Learned Terms</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="reportTemplate" class="hidden bg-white text-black p-10 max-w-2xl mx-auto">
        <div class="border-b-2 border-black pb-4 mb-6">
            <h1 class="text-3xl font-bold">Resume Analysis Report</h1>
            <p class="text-gray-500" id="reportDate">Generated by ResuMatch Pro</p>
        </div>
        <div class="mb-6">
            <h2 class="text-xl font-bold mb-2">Summary</h2>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded">
                <span class="text-lg">Overall Match</span>
                <span class="text-3xl font-bold text-blue-600" id="reportScore">0%</span>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-6 mb-6">
            <div>
                <h3 class="font-bold border-b border-gray-300 mb-2">Missing Critical Skills</h3>
                <ul id="reportMissing" class="list-disc pl-5 text-sm text-red-600 space-y-1"></ul>
            </div>
            <div>
                <h3 class="font-bold border-b border-gray-300 mb-2">Matched Strengths</h3>
                <ul id="reportMatched" class="list-disc pl-5 text-sm text-green-700 space-y-1"></ul>
            </div>
        </div>
        <div class="mt-8 text-center text-xs text-gray-400">
            CONFIDENTIAL - Internal Use Only
        </div>
    </div>

    <script>
        // --- 1. DATASETS (The "Brains" of the Robustness) ---
        const POWER_VERBS = new Set(['managed','led','developed','created','designed','implemented','optimized','engineered','spearheaded','launched','achieved','improved','increased','decreased','negotiated','mentored','directed','coordinated','analyzed','solved']);
        const SOFT_SKILLS = new Set(['leadership','communication','teamwork','collaboration','problem solving','adaptability','creativity','time management','critical thinking','emotional intelligence','empathy','negotiation']);
        const STOP_WORDS = new Set(["a","and","the","in","on","at","to","for","of","with","by","is","are","was","were","be","been","have","has","had","it","this","that","i","you","we","they","candidate","resume","page","experience","years","work","job","role"]);

        // --- 2. STATE & UTILS ---
        let currentMode = 'candidate';
        let ignoredTerms = JSON.parse(localStorage.getItem('resumatch_ignored')) || [];

        function switchMode(mode) {
            currentMode = mode;
            // Update Sidebar UI
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${mode}`).classList.add('active');
            
            // Show/Hide Views
            ['candidate', 'recruiter', 'settings'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${mode}`).classList.remove('hidden');

            // Update Title
            const titles = { candidate: 'Candidate Optimizer', recruiter: 'Recruiter Ranking (Batch)', settings: 'System Settings' };
            document.getElementById('pageTitle').innerText = titles[mode];
        }

        function cleanText(text) {
            return text.toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ') // Replace symbols with space
                .replace(/\s+/g, ' ')         // Collapse whitespace
                .trim();
        }

        // --- 3. CORE ANALYZER ENGINE ---
        function analyzeText(resumeText, jdText) {
            const jdClean = cleanText(jdText);
            const resumeClean = cleanText(resumeText);
            
            // A. Hard Skills (Weighted Extraction from JD)
            const jdTokens = jdClean.split(' ').filter(w => w.length > 2 && !STOP_WORDS.has(w) && !ignoredTerms.includes(w));
            const jdFreq = {};
            jdTokens.forEach(w => jdFreq[w] = (jdFreq[w] || 0) + 1);
            
            let totalHardWeight = 0;
            let matchedHardWeight = 0;
            const missingHard = [];
            const matchedHard = [];
            
            // Take top 50 meaningful words from JD
            const importantKeywords = Object.keys(jdFreq).sort((a,b) => jdFreq[b] - jdFreq[a]).slice(0, 50);

            importantKeywords.forEach(word => {
                totalHardWeight += jdFreq[word];
                if(resumeClean.includes(word)) {
                    matchedHardWeight += jdFreq[word];
                    matchedHard.push(word);
                } else {
                    missingHard.push(word);
                }
            });

            // B. Soft Skills Analysis
            let softCount = 0;
            SOFT_SKILLS.forEach(skill => {
                if(resumeClean.includes(skill)) softCount++;
            });

            // C. Power Verb Analysis
            let verbCount = 0;
            const foundVerbs = [];
            POWER_VERBS.forEach(verb => {
                if(resumeClean.includes(` ${verb} `)) { // Space padding to ensure whole word
                    verbCount++;
                    foundVerbs.push(verb);
                }
            });

            // D. Composite Scoring
            // 70% Hard Skills Match, 15% Soft Skills Bonus, 15% Verb Bonus
            const hardScore = (matchedHardWeight / (totalHardWeight || 1)) * 100;
            const softBonus = Math.min(softCount * 5, 100); // Cap bonus
            const verbBonus = Math.min(verbCount * 5, 100);

            const finalScore = Math.round((hardScore * 0.7) + (softBonus * 0.15) + (verbBonus * 0.15));

            return {
                score: Math.min(finalScore, 100),
                hardMatches: matchedHard,
                hardMissing: missingHard,
                softCount,
                verbCount,
                foundVerbs
            };
        }

        // --- 4. CANDIDATE MODE LOGIC ---
        async function handleSingleUpload(input) {
            const file = input.files[0];
            const jd = document.getElementById('jdInput').value;
            if (!file || !jd) { alert("Please provide both JD and Resume PDF"); return; }

            const text = await parsePDF(file);
            const result = analyzeText(text, jd);

            // Render Results
            document.getElementById('candidateStats').classList.remove('hidden');
            document.getElementById('candidateReport').classList.remove('hidden');
            
            document.getElementById('singleScore').innerText = result.score + '%';
            document.getElementById('scoreBar').style.width = result.score + '%';
            document.getElementById('cntHard').innerText = result.hardMatches.length;
            document.getElementById('cntSoft').innerText = result.softCount;
            
            // Verdict
            const v = document.getElementById('singleVerdict');
            if(result.score > 80) { v.innerText = "Excellent Fit"; v.className = "text-xs text-emerald-400 mb-1"; }
            else if(result.score > 50) { v.innerText = "Potential Fit"; v.className = "text-xs text-amber-400 mb-1"; }
            else { v.innerText = "Low Fit"; v.className = "text-xs text-red-400 mb-1"; }

            // Verb Impact
            const vs = document.getElementById('verbScore');
            if(result.verbCount > 5) { vs.innerText = "High Impact"; vs.className = "text-xs bg-emerald-900/50 px-2 py-1 rounded text-emerald-400"; }
            else { vs.innerText = "Passive Tone"; vs.className = "text-xs bg-red-900/50 px-2 py-1 rounded text-red-400"; }

            // Lists
            renderTags('missingList', result.hardMissing.slice(0, 10), 'red', true); // Interactive
            renderTags('matchedList', result.hardMatches, 'emerald', false);
            renderTags('verbList', result.foundVerbs, 'amber', false);

            // Prepare Report Data
            prepareReport(result);
        }

        // --- 5. RECRUITER MODE LOGIC (Batch) ---
        async function handleBatchUpload(input) {
            const files = Array.from(input.files);
            const jd = document.getElementById('jdInput').value;
            if (files.length === 0 || !jd) { alert("Please provide JD and Resumes"); return; }

            document.getElementById('batchResults').classList.remove('hidden');
            document.getElementById('candidateCount').innerText = `${files.length} Candidates Analyzing...`;
            
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = ''; // Clear

            const results = [];

            // Process sequentially to prevent browser freeze
            for (const file of files) {
                try {
                    const text = await parsePDF(file);
                    const metrics = analyzeText(text, jd);
                    results.push({ name: file.name, ...metrics });
                } catch (e) {
                    console.error("Failed to parse", file.name);
                }
            }

            // Sort by Score DESC
            results.sort((a,b) => b.score - a.score);

            // Render Table
            document.getElementById('candidateCount').innerText = `${results.length} Candidates Processed`;
            
            results.forEach((r, index) => {
                const tr = document.createElement('tr');
                tr.className = "bg-slate-800/20 border-b border-white/5 hover:bg-white/5 transition";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-white">#${index + 1}</td>
                    <td class="px-6 py-4 text-slate-300 flex items-center gap-2">
                        <i class="fa-regular fa-file-pdf text-red-400"></i> ${r.name}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded font-bold text-xs ${getScoreColor(r.score)}">${r.score}%</span>
                    </td>
                    <td class="px-6 py-4 text-slate-400">${r.hardMatches.length} Found</td>
                    <td class="px-6 py-4 text-slate-400">${r.softCount} Detected</td>
                    <td class="px-6 py-4">
                        <button class="text-brand-500 hover:text-white text-xs underline">Details</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 6. UTILITIES ---
        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(i => i.str).join(" ") + " ";
            }
            return fullText;
        }

        function renderTags(id, items, color, interactive) {
            const container = document.getElementById(id);
            container.innerHTML = items.map(i => `
                <span class="px-2 py-1 rounded bg-${color}-500/10 border border-${color}-500/20 text-${color}-400 text-xs flex items-center gap-1 group">
                    ${i}
                    ${interactive ? `<i onclick="ignoreTerm('${i}')" class="fa-solid fa-ban ml-1 opacity-50 hover:opacity-100 cursor-pointer text-red-400" title="Train AI to Ignore"></i>` : ''}
                </span>
            `).join('');
        }

        function getScoreColor(s) {
            if(s > 80) return 'bg-emerald-500/20 text-emerald-400';
            if(s > 50) return 'bg-amber-500/20 text-amber-400';
            return 'bg-red-500/20 text-red-400';
        }

        function ignoreTerm(term) {
            if(confirm(`Ignore "${term}" globally?`)) {
                ignoredTerms.push(term);
                localStorage.setItem('resumatch_ignored', JSON.stringify(ignoredTerms));
                alert("Model Updated. Re-run analysis to see changes.");
            }
        }
        
        function resetMemory() {
            localStorage.removeItem('resumatch_ignored');
            ignoredTerms = [];
            alert("Memory Cleared");
        }
        // --- 7. EXPORT & REPORTING ---
        function prepareReport(result) {
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString();
            document.getElementById('reportScore').innerText = result.score + '%';
            
            const missingList = document.getElementById('reportMissing');
            missingList.innerHTML = result.hardMissing.slice(0, 10).map(i => `<li>${i}</li>`).join('');

            const matchedList = document.getElementById('reportMatched');
            matchedList.innerHTML = result.hardMatches.slice(0, 10).map(i => `<li>${i}</li>`).join('');
        }

        function downloadReport() {
            const element = document.getElementById('reportTemplate');
            element.classList.remove('hidden'); // Show temp
            
            const opt = {
                margin: 1,
                filename: 'ResuMatch_Analysis.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.add('hidden'); // Hide again
            });
        }
    </script>
</body>
</html>
